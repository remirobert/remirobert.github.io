<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>1️⃣ Node.js Authentification 🔒</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,600">
  <link rel="stylesheet" href="/style.css">
  </head>
<body>
  <div class="container">
    <header class="masthead">
  <h1 class="masthead-title--small">
    <a href="/">📱 Remi</a>
  </h1>
</header>      
<div class="content post">
  <h1 class="post-title">1️⃣ Node.js Authentification 🔒</h1>
  <div class="post-date">
    <time>09 Dec 2015</time>
  </div>
  <p class="lead">How to build an <strong>authentification</strong> strategy for <strong>Node.js</strong>, for web and mobile.</p>

<p>I am currently working on a project, where I needed to build a RESTFUl API, for an <strong>iOS</strong> and <strong>web</strong> application. And the first thing I really needed, was the login, and the user management.
So for doing that, I looked around the web to find, what is the best design for the authentification.</p>

<p>At the end, I am able to login with facebook, or with the old school way (<em>email, password</em>). And with token authentification for the mobile.</p>

<h3 id="packages">Packages</h3>
<p>So first, we will need some packages.
We will use express, and passport.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"express-auth-example"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Remi ROBERT"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"body-parser"</span><span class="p">:</span><span class="s2">"~1.14.1"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.13.3"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"passport"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.2.2"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"passport-http-bearer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.0.1"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"passport-local"</span><span class="p">:</span><span class="s2">"^1.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"mongoose"</span><span class="p">:</span><span class="s2">"~4.2.9"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th>package</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>express</td>
      <td>Web framework, handle, HTTP server, and rooting.</td>
    </tr>
    <tr>
      <td>passport</td>
      <td>Handle the authentification around express</td>
    </tr>
    <tr>
      <td>body-parser</td>
      <td>Parse the body parameters in a POST request for express.</td>
    </tr>
    <tr>
      <td>passport-local</td>
      <td>Provides a basic authentification strategy. Email and password ✌️</td>
    </tr>
    <tr>
      <td>passport-http-bearer</td>
      <td>HTTP Bearer authentication strategy for Passport. Will protect all the endpoint of the API.</td>
    </tr>
    <tr>
      <td>mongoose</td>
      <td>Elegant mongodb object modeling for node.js.</td>
    </tr>
  </tbody>
</table>

<p>After an <code class="highlighter-rouge">npm install</code>, we are defenitely ready to code… 👻</p>

<h3 id="architecture">Architecture</h3>

<p>This is our architecture, very, I mean extremely basic 😙 :</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">.</span>
<span class="err">├──</span> <span class="nx">controllers</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">js</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">user</span><span class="p">.</span><span class="nx">js</span>
<span class="err">├──</span> <span class="nx">node_modules</span><span class="p">....</span>
<span class="err">├──</span> <span class="nx">models</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">js</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">user</span><span class="p">.</span><span class="nx">js</span>
<span class="err">├──</span> <span class="kr">package</span><span class="p">.</span><span class="nx">json</span>
<span class="err">├──</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">js</span>
<span class="err">└──</span> <span class="nx">server</span><span class="p">.</span><span class="nx">js</span></code></pre></figure>

<h3 id="models">Models</h3>

<p>Alright, first, let’s create our models. We need only two models, one for the <strong>User</strong>, and an another one for the <strong>AccessToken</strong>.
Let’s keep it, as simple as we can, just for the example. We don’t need useless data, only an <em>username</em> for the <strong>User</strong> 😙.</p>

<p>◉   Let’s take a look at the <strong>user.js</strong> :  let’s take a look at the <strong>user.js</strong> :</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Schema</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
  <span class="na">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">password</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">});</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="nx">User</span><span class="p">);</span></code></pre></figure>

<p>◉   And the <strong>accessToken.js</strong> :</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Schema</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">AccessToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
  <span class="na">token</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="s1">'Category'</span> <span class="p">}</span>
<span class="p">});</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'AccessToken'</span><span class="p">,</span> <span class="nx">AccessToken</span><span class="p">);</span></code></pre></figure>

<h3 id="server">Server</h3>

<p>So first, we need to initialise our http server, thanks to express, this task is pretty easy.
This is my <strong>server.js</strong> file :</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'mongodb://localhost/my_database'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/user'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">AccessToken</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/accessToken'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">'./passport'</span><span class="p">)(</span><span class="nx">passport</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/'</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/user'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/auth'</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/auth'</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span></code></pre></figure>

<h3 id="passport">Passport</h3>

<p>We need to configure passport, with our strategies. In the first part, we don’t have any social integration.
Only the <strong>basic authentification</strong>, and the <strong>bereer token</strong>.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">passport</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">BearerStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport-http-bearer'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">LocalStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport-local'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/user'</span><span class="p">);</span>
  
  <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">BearerStrategy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">token</span><span class="p">:</span> <span class="nx">token</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="p">{</span> <span class="na">scope</span><span class="p">:</span> <span class="s1">'all'</span> <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}));</span>

  <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">!==</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}));</span>
  <span class="k">return</span> <span class="nx">module</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<h3 id="controllers">Controllers</h3>

<p>Now, we need some controllers.</p>

<h4 id="user">User</h4>
<p>Basically in our case this controller, will contain only a single endpoint, to fetch the current User.
The route is protected by the <strong>bareer token</strong>, thanks to the <em>passport middleware</em>.</p>

<p>◉   Here the <strong>user.js</strong> :</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'.././models/user'</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/profile'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'bearer'</span><span class="p">,</span>
 <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
 </code></pre></figure>

<p>And an another one, the <strong>auth</strong> controller, which will handle all the way to auth an user.
In the first time, we have only the basic authentification.</p>

<p>◉   And the <strong>auth.js</strong> :</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'.././models/user'</span><span class="p">);</span> 

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/signup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">401</span><span class="p">);</span> 
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    
  <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">username</span><span class="p">:</span> <span class="nx">username</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span>
        <span class="s2">"username"</span><span class="p">:</span> <span class="nx">username</span><span class="p">,</span>
        <span class="s2">"password"</span><span class="p">:</span> <span class="nx">password</span><span class="p">,</span>
      <span class="p">});</span>

      <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ex</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">newUser</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">newUser</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"model save"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"error"</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span> 
     <span class="p">}</span>
  <span class="p">});</span>  
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'local'</span><span class="p">,</span> <span class="p">{</span> <span class="na">failureRedirect</span><span class="p">:</span> <span class="s1">'/login'</span> <span class="p">}),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="p">?</span> <span class="mi">200</span> <span class="p">:</span> <span class="mi">401</span><span class="p">);</span>
<span class="p">});</span>
 </code></pre></figure>


</div>

  </div>
</body>
</html>
